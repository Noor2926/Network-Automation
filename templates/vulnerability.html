{% extends 'layout.html' %}

{% block content %}
<header class="mb-8">
    <div class="flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-800">Vulnerability Scanner</h1>
        <div class="flex space-x-2">
            <button id="helpBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                Help
            </button>
        </div>
    </div>
</header>

<!-- Scan Configuration -->
<div class="bg-white p-4 rounded-lg shadow mb-6">
    <h2 class="text-lg font-semibold mb-4">Scan Configuration</h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label for="targetInput" class="block text-sm font-medium text-gray-700 mb-1">Target IP/Hostname</label>
            <input type="text" id="targetInput" placeholder="e.g., 192.168.1.1 or example.com" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
        
        <div>
            <label for="scanDepthSelect" class="block text-sm font-medium text-gray-700 mb-1">Scan Depth</label>
            <select id="scanDepthSelect" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="basic">Basic (Fast)</option>
                <option value="standard" selected>Standard</option>
                <option value="deep">Deep (Thorough)</option>
            </select>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
            <label for="scanTypeSelect" class="block text-sm font-medium text-gray-700 mb-1">Vulnerability Categories</label>
            <select id="scanTypeSelect" class="w-full p-2 border border-gray-300 rounded-md" multiple size="4">
                <option value="cve" selected>Common Vulnerabilities (CVE)</option>
                <option value="misconfig" selected>Misconfigurations</option>
                <option value="outdated" selected>Outdated Software</option>
                <option value="webapp">Web Application Vulnerabilities</option>
                <option value="auth">Authentication Issues</option>
                <option value="encryption">Encryption Weaknesses</option>
            </select>
            <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple</p>
        </div>
        
        <div>
            <label for="timeoutInput" class="block text-sm font-medium text-gray-700 mb-1">Timeout (minutes)</label>
            <input type="number" id="timeoutInput" value="10" min="1" max="60" class="w-full p-2 border border-gray-300 rounded-md">
            <div class="mt-4">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="nonIntrusiveCheck" class="form-checkbox h-4 w-4 text-blue-600" checked>
                    <span class="ml-2 text-sm text-gray-700">Non-intrusive scan only</span>
                </label>
            </div>
        </div>
    </div>
    
    <div class="flex justify-end space-x-2">
        <button id="startScanBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
            Start Scan
        </button>
        <button id="cancelScanBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md opacity-50" disabled>
            Cancel
        </button>
    </div>
</div>

<!-- Status Bar -->
<div id="scanStatus" class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 mb-6 rounded hidden">
    <div class="flex">
        <div class="flex-shrink-0">
            <div class="animate-spin h-5 w-5 border-2 border-blue-500 rounded-full border-t-transparent"></div>
        </div>
        <div class="ml-3">
            <p class="font-medium">Vulnerability scan in progress</p>
            <p id="scanProgress" class="text-sm">Phase: Initializing...</p>
        </div>
    </div>
</div>

<!-- Results -->
<div class="bg-white p-4 rounded-lg shadow">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold">Vulnerability Report</h2>
        <div>
            <button id="exportReportBtn" class="text-sm text-blue-600 hover:text-blue-800 mr-4">Export Report</button>
            <button id="clearResultsBtn" class="text-sm text-red-600 hover:text-red-800">Clear</button>
        </div>
    </div>
    
    <div id="resultsContainer" class="hidden">
        <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <div class="grid grid-cols-2 gap-2 text-sm">
                <div>
                    <span class="font-medium">Target:</span>
                    <span id="resultTarget">-</span>
                </div>
                <div>
                    <span class="font-medium">Scan Date:</span>
                    <span id="resultScanDate">-</span>
                </div>
                <div>
                    <span class="font-medium">Scan Duration:</span>
                    <span id="resultDuration">-</span>
                </div>
                <div>
                    <span class="font-medium">Vulnerabilities Found:</span>
                    <span id="resultVulnCount">-</span>
                </div>
            </div>
        </div>
        
        <!-- Vulnerability Summary -->
        <div class="mb-6">
            <h3 class="text-md font-medium mb-3">Vulnerability Summary</h3>
            <div class="flex space-x-4">
                <div class="flex-1 bg-red-50 p-3 rounded-lg border border-red-100">
                    <div class="text-sm text-gray-500">Critical</div>
                    <div id="criticalCount" class="text-2xl font-bold text-red-600">0</div>
                </div>
                <div class="flex-1 bg-orange-50 p-3 rounded-lg border border-orange-100">
                    <div class="text-sm text-gray-500">High</div>
                    <div id="highCount" class="text-2xl font-bold text-orange-600">0</div>
                </div>
                <div class="flex-1 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                    <div class="text-sm text-gray-500">Medium</div>
                    <div id="mediumCount" class="text-2xl font-bold text-yellow-600">0</div>
                </div>
                <div class="flex-1 bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <div class="text-sm text-gray-500">Low</div>
                    <div id="lowCount" class="text-2xl font-bold text-blue-600">0</div>
                </div>
            </div>
        </div>
        
        <!-- Vulnerability List -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead>
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Severity</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vulnerability</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Affected Component</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    </tr>
                </thead>
                <tbody id="vulnerabilityList" class="divide-y divide-gray-200">
                    <tr>
                        <td colspan="4" class="px-4 py-4 text-sm text-center text-gray-500">
                            No vulnerabilities found.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <div id="noResultsMessage" class="py-8 text-center text-gray-500">
        No vulnerability scan results yet. Configure and start a scan above.
    </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-2xl max-h-[80vh] overflow-y-auto">
        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold">Vulnerability Scanner Help</h3>
            <button id="closeHelpModal" class="text-gray-500 hover:text-gray-700">
                âœ•
            </button>
        </div>
        <div class="p-4">
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium text-lg mb-2">Getting Started</h4>
                    <p>The Vulnerability Scanner checks for security issues on network devices.</p>
                    <ol class="list-decimal list-inside mt-2 space-y-1">
                        <li>Enter a target IP address or hostname</li>
                        <li>Select the scan depth and vulnerability categories</li>
                        <li>Choose whether to use non-intrusive scanning only</li>
                        <li>Click "Start Scan"</li>
                    </ol>
                </div>
                
                <div>
                    <h4 class="font-medium text-lg mb-2">Scan Depth Options</h4>
                    <ul class="space-y-2">
                        <li><span class="font-medium">Basic:</span> Quick scan for common vulnerabilities</li>
                        <li><span class="font-medium">Standard:</span> Balanced scan for most vulnerabilities</li>
                        <li><span class="font-medium">Deep:</span> Thorough scan that takes longer but finds more issues</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-medium text-lg mb-2">Vulnerability Categories</h4>
                    <ul class="space-y-1">
                        <li><span class="font-medium">Common Vulnerabilities (CVE):</span> Known security issues in the CVE database</li>
                        <li><span class="font-medium">Misconfigurations:</span> Security issues from incorrect settings</li>
                        <li><span class="font-medium">Outdated Software:</span> Risks from using old software versions</li>
                        <li><span class="font-medium">Web Application:</span> Vulnerabilities in web applications</li>
                        <li><span class="font-medium">Authentication:</span> Issues with login systems</li>
                        <li><span class="font-medium">Encryption:</span> Problems with data protection</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-medium text-lg mb-2">Important Notes</h4>
                    <ul class="list-disc list-inside mt-2 space-y-1">
                        <li>Only scan systems you have permission to test</li>
                        <li>Some scans may trigger security systems or affect performance</li>
                        <li>Use "Non-intrusive scan only" for production systems</li>
                        <li>Results should be verified by security professionals</li>
                    </ul>
                </div>
            </div>
            
            <div class="mt-6 pt-4 border-t border-gray-200 flex justify-end">
                <button id="closeHelpModalBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Help modal functionality
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelpModal = document.getElementById('closeHelpModal');
        const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
        
        helpBtn.addEventListener('click', function() {
            helpModal.classList.remove('hidden');
        });
        
        closeHelpModal.addEventListener('click', function() {
            helpModal.classList.add('hidden');
        });
        
        closeHelpModalBtn.addEventListener('click', function() {
            helpModal.classList.add('hidden');
        });
        
        // Vulnerability scanner functionality
        const startScanBtn = document.getElementById('startScanBtn');
        const cancelScanBtn = document.getElementById('cancelScanBtn');
        const scanStatus = document.getElementById('scanStatus');
        const scanProgress = document.getElementById('scanProgress');
        const resultsContainer = document.getElementById('resultsContainer');
        const noResultsMessage = document.getElementById('noResultsMessage');
        
        startScanBtn.addEventListener('click', function() {
            const target = document.getElementById('targetInput').value.trim();
            const scanDepth = document.getElementById('scanDepthSelect').value;
            const timeout = document.getElementById('timeoutInput').value;
            const nonIntrusive = document.getElementById('nonIntrusiveCheck').checked;
            
            // Get selected vulnerability categories
            const scanTypeSelect = document.getElementById('scanTypeSelect');
            const selectedCategories = Array.from(scanTypeSelect.selectedOptions).map(option => option.value);
            
            if (!target) {
                alert('Please enter a target IP or hostname');
                return;
            }
            
            // Show scanning status
            scanStatus.classList.remove('hidden');
            startScanBtn.disabled = true;
            cancelScanBtn.disabled = false;
            cancelScanBtn.classList.remove('opacity-50');
            
            // Make API request to start scan
            fetch('/api/vulnerability-scan', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    target: target,
                    scan_depth: scanDepth,
                    categories: selectedCategories,
                    timeout: parseInt(timeout),
                    non_intrusive: nonIntrusive
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update UI with results
                updateResults(data, target);
                
                // Hide scanning status
                scanStatus.classList.add('hidden');
                startScanBtn.disabled = false;
                cancelScanBtn.disabled = true;
                cancelScanBtn.classList.add('opacity-50');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error scanning for vulnerabilities: ' + error.message);
                
                // Hide scanning status
                scanStatus.classList.add('hidden');
                startScanBtn.disabled = false;
                cancelScanBtn.disabled = true;
                cancelScanBtn.classList.add('opacity-50');
            });
            
            // Simulate scan phases (in a real app, this would come from a WebSocket or polling)
            const phases = [
                'Initializing...',
                'Port scanning...',
                'Service detection...',
                'Checking for CVEs...',
                'Analyzing configurations...',
                'Testing for vulnerabilities...',
                'Generating report...'
            ];
            
            let phaseIndex = 0;
            const phaseInterval = setInterval(() => {
                scanProgress.textContent = `Phase: ${phases[phaseIndex]}`;
                phaseIndex++;
                
                if (phaseIndex >= phases.length) {
                    clearInterval(phaseInterval);
                }
            }, 3000);
        });
        
        cancelScanBtn.addEventListener('click', function() {
            // Make API request to cancel scan
            fetch('/api/vulnerability-scan/cancel', {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Hide scanning status
                scanStatus.classList.add('hidden');
                startScanBtn.disabled = false;
                cancelScanBtn.disabled = true;
                cancelScanBtn.classList.add('opacity-50');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error cancelling scan: ' + error.message);
            });
        });
        
        // Clear results button
        document.getElementById('clearResultsBtn').addEventListener('click', function() {
            resultsContainer.classList.add('hidden');
            noResultsMessage.classList.remove('hidden');
            document.getElementById('vulnerabilityList').innerHTML = `
                <tr>
                    <td colspan="4" class="px-4 py-4 text-sm text-center text-gray-500">
                        No vulnerabilities found.
                    </td>
                </tr>
            `;
        });
        
        // Export report button
        document.getElementById('exportReportBtn').addEventListener('click', function() {
            alert('Export functionality will be implemented here');
        });
        
        // Function to update results in the UI
        function updateResults(data, target) {
            // Update summary information
            document.getElementById('resultTarget').textContent = target;
            document.getElementById('resultScanDate').textContent = new Date().toLocaleString();
            document.getElementById('resultDuration').textContent = data.duration + ' minutes';
            document.getElementById('resultVulnCount').textContent = data.total_vulnerabilities || 0;
            
            // Update vulnerability counts
            document.getElementById('criticalCount').textContent = data.critical_count || 0;
            document.getElementById('highCount').textContent = data.high_count || 0;
            document.getElementById('mediumCount').textContent = data.medium_count || 0;
            document.getElementById('lowCount').textContent = data.low_count || 0;
            
            // Show results container, hide no results message
            resultsContainer.classList.remove('hidden');
            noResultsMessage.classList.add('hidden');
            
            // Clear previous results
            const vulnerabilityList = document.getElementById('vulnerabilityList');
            vulnerabilityList.innerHTML = '';
            
            // Add new results
            if (data.vulnerabilities && data.vulnerabilities.length > 0) {
                data.vulnerabilities.forEach(vuln => {
                    const row = document.createElement('tr');
                    
                    // Determine severity class
                    let severityClass = '';
                    switch (vuln.severity.toLowerCase()) {
                        case 'critical':
                            severityClass = 'bg-red-100 text-red-800';
                            break;
                        case 'high':
                            severityClass = 'bg-orange-100 text-orange-800';
                            break;
                        case 'medium':
                            severityClass = 'bg-yellow-100 text-yellow-800';
                            break;
                        case 'low':
                            severityClass = 'bg-blue-100 text-blue-800';
                            break;
                        default:
                            severityClass = 'bg-gray-100 text-gray-800';
                    }
                    
                    row.innerHTML = `
                        <td class="px-4 py-2">
                            <span class="px-2 py-1 text-xs rounded-full ${severityClass}">
                                ${vuln.severity}
                            </span>
                        </td>
                        <td class="px-4 py-2">
                            <div class="font-medium">${vuln.name}</div>
                            <div class="text-xs text-gray-500">${vuln.id || 'N/A'}</div>
                        </td>
                        <td class="px-4 py-2">${vuln.affected_component}</td>
                        <td class="px-4 py-2">
                            <p class="text-sm">${vuln.description}</p>
                            <div class="mt-1 text-xs">
                                <span class="font-medium">Recommendation:</span> ${vuln.recommendation || 'N/A'}
                            </div>
                        </td>
                    `;
                    vulnerabilityList.appendChild(row);
                });
            } else {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="4" class="px-4 py-4 text-sm text-center text-gray-500">
                        No vulnerabilities found on the target.
                    </td>
                `;
                vulnerabilityList.appendChild(row);
            }
        }
    });
</script>
{% endblock %}